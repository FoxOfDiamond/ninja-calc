<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="stylesheet.css">
    <title>
        BTD6 Ninja calculator
    </title>
</head>

<body class="no-margin">
    <div class="root">
        <div class="flex flex-row default-flex-gap">
            <div>
                <h3>Constraints (ninjas only)</h3>
                <div class="input"><input type="number" id="input-cash" value=10000> Max cash <br></div>
                <div class="input"><input type="number" id="input-monkeys" value = 30> Max monkeys <br></div>
                <div class="input"><input type="number" id="input-tiers" value = 120> Max tiers <br></div>
                <div class="input"><select id="input-difficulty">
                        <option value="0">Easy</option>
                        <option value="1">Normal</option>
                        <option value="2">Hard</option>
                        <option value="3">Chimps/Impoppable</option>
                    </select> Difficulty <br></div>
                <div class="input"><input type="checkbox" id="input-camo"> Camo <br></div>
                <h3>Aura/permanent buffs</h3>
                <div class="input"><select id="input-sun-temple">
                        <option value="0">0 ($0 - $10,000)</option>
                        <option value="1">1 ($10,001 - $15,000)</option>
                        <option value="2">2 ($15,001 - $20,000)</option>
                        <option value="3">3 ($20,001 - $25,000)</option>
                        <option value="4">4 ($25,001 - $30,000)</option>
                        <option value="5">5 ($30,001 - $35,000)</option>
                        <option value="6">6 ($35,001 - $40,000)</option>
                        <option value="7">7 ($40,001 - $45,000)</option>
                        <option value="8">8 ($45,001 - $50,000)</option>
                        <option value="9">9 ($50,001 or more)</option>
                    </select> Sun temple tier <br></div>
                <div class="input"><select id="input-sun-god">
                        <option value="0">0 ($0 - $10,000)</option>
                        <option value="1">1 ($10,001 - $15,000)</option>
                        <option value="2">2 ($15,001 - $20,000)</option>
                        <option value="3">3 ($20,001 - $25,000)</option>
                        <option value="4">4 ($25,001 - $30,000)</option>
                        <option value="5">5 ($30,001 - $35,000)</option>
                        <option value="6">6 ($35,001 - $40,000)</option>
                        <option value="7">7 ($40,001 - $45,000)</option>
                        <option value="8">8 ($45,001 - $50,000)</option>
                        <option value="9">9 ($50,001 or more)</option>
                    </select> Sun god tier <br></div>
                <div class="input"><input type="number" id="input-gerry-fire" value = 0> Gerry's fire <br></div>
                <div class="input"><input type="number" id="input-village-discount" value = 1> Village discount stacks <br></div>
                <div class="input"><input type="checkbox" id="input-jungle-drums"> Jungle drums <br></div>
                <div class="input"><input type="checkbox" id="input-perma-brew"> Perma brew <br></div>
                <div class="input"><input type="checkbox" id="input-energizer"> Energizer <br></div>
                <h3>Temporary buffs</h3>
                <div class="input"><input type="checkbox" id="input-homeland"> Homeland defense <br></div>
                <div class="input"><input type="checkbox" id="input-cta"> Call to arms <br></div>
                <div class="input"><input type="checkbox" id="input-grand-sabo"> Grand saboteur ability <br></div>
                <h3>Monkey knowledge</h3>
                <div class="input"><input type="checkbox" id="input-global-ability-cooldowns"> Global ability cooldowns <br></div>
                <div class="input"><input type="checkbox" id="input-to-arms"> To arms! <br></div>
                <div class="input"><input type="checkbox" id="input-deadly-tranquility"> Deadly tranquility <br></div>
                <div class="input"><input type="checkbox" id="input-cheaper-doubles"> Cheaper doubles <br></div>
                <div class="input"><input type="checkbox" id="input-insider-trades"> Insider trades <br></div>
                <h3>Debuffs</h3>
                <div class="input"><select id="input-glue-strike">
                        <option value="0">none</option>
                        <option value="0">1 0-4-x</option>
                        <option value="1">2 0-4-x</option>
                        <option value="2">1 2-4-x</option>
                        <option value="3">2 2-4-x</option>
                    </select> Glue strike <br></div>
                <div class="input"><input type="checkbox" id="input-embrittlement"> Embrittlement <br></div>
                <div class="input"><input type="checkbox" id="input-super-brittle"> Super brittle <br></div>
                <div class="input"><input type="checkbox" id="input-cripple"> Cripple moab <br></div>
            </div>
            <div>
                <h3>Output</h3>
                <div><span id="dps-output">0</span> DPS <br></div>
                <div><span id="cash-output">0</span> Cash <br></div>
                <div><span id="tiers-output">0</span> Tiers <br></div>
                <div><span id="monkeys-output">0</span> Monkeys <br></div>
                <h3>Details</h3>
                <div><span id="attack-speed-output">0</span> Attack speed bonus <br></div>
                <div><span id="damage-output">0</span> Damage bonus <br></div>
                <div><span id="shinobi-dps-output">0</span> Shinobi dps<br></div>
                <div><span id="bloonjitsu-dps-output">0</span> Bloonjitsu dps<br></div>
                <div><span id="gmn-dps-output">0</span> Grandmaster dps<br></div>
                <div><span id="caltrop-dps-output">0</span> Caltrop dps<br></div>
                <h3>Strategy</h3>
                <div><span id="shinobi-output">0</span> Shinobis <br></div>
                <div><span id="bloonjitsu-output">0</span> Bloonjitsus <br></div>
                <div><span id="gmn-output">0</span> Grandmaster ninja <br></div>
                <div><span id="caltrop-output">0</span> Caltrops <br></div>
            </div>
        </div>
    </div>
</body>

<script>
    function update() {
        var monkey_knowledge = {
            global_ability_cooldowns: false,
            to_arms: false,
            deadly_tranquility: false,
            cheaper_doubles: false,
            insider_trades: false
        }
        var permanent_buffs = {
            sun_temple: 9,
            sun_god: 9,
            jungle_drums: true,
            perma_brew: true,
            gerry_fire: 0,
            village_discount: 3
        }
        var difficulty = 0;
        var constraints = {
            max_monkeys: 30,
            max_tiers: 200,
            max_cash: 100000,
            camo: false
        }
        monkey_knowledge.global_ability_cooldowns = document.getElementById("input-global-ability-cooldowns").checked
        monkey_knowledge.to_arms = document.getElementById("input-to-arms").checked
        monkey_knowledge.deadly_tranquility = document.getElementById("input-deadly-tranquility").checked
        monkey_knowledge.cheaper_doubles = document.getElementById("input-cheaper-doubles").checked
        monkey_knowledge.insider_trades = document.getElementById("input-insider-trades").checked
        
        permanent_buffs.sun_god = Number(document.getElementById("input-sun-god").value)
        permanent_buffs.sun_temple = Number(document.getElementById("input-sun-temple").value)
        permanent_buffs.jungle_drums = document.getElementById("input-jungle-drums").checked
        permanent_buffs.perma_brew = document.getElementById("input-perma-brew").checked
        permanent_buffs.gerry_fire = Number(document.getElementById("input-gerry-fire").value)
        permanent_buffs.village_discount = Number(document.getElementById("input-village-discount").value)

        difficulty = Number(document.getElementById("input-difficulty").value)

        constraints.max_monkeys = Number(document.getElementById("input-monkeys").value)
        constraints.max_tiers = Number(document.getElementById("input-tiers").value)
        constraints.max_cash = Number(document.getElementById("input-cash").value)
        constraints.camo = document.getElementById("input-camo").checked

        //console.log(constraints, typeof(constraints.max_cash))

        var difficulty_modifier = 1;
        var difficulty_price = [
            0.85,
            1,
            1.08,
            1.2
        ]
        var support_sacrifice = {
            0:{
                flat_damage: 0,
                flat_pierce: 0,
                cooldown: 1,
                discount: 0
            },
            1:{
                flat_damage: 0,
                flat_pierce: 0,
                cooldown: 1,
                discount: 0
            },
            2:{
                flat_damage: 0,
                flat_pierce: 0,
                cooldown: 1,
                discount: 0.1
            },
            3:{
                flat_damage: 0,
                flat_pierce: 0,
                cooldown: 0.9,
                discount: 0.1
            },
            4:{
                flat_damage: 0,
                flat_pierce: 0,
                cooldown: 0.9,
                discount: 0.1
            },
            5:{
                flat_damage: 0,
                flat_pierce: 3,
                cooldown: 0.9,
                discount: 0.1
            },
            6:{
                flat_damage: 1,
                flat_pierce: 3,
                cooldown: 0.9,
                discount: 0.1
            },
            7:{
                flat_damage: 1,
                flat_pierce: 3,
                cooldown: 0.9,
                discount: 0.2
            },
            8:{
                flat_damage: 1,
                flat_pierce: 3,
                cooldown: 0.81,
                discount: 0.2
            },
            9:{
                flat_damage: 2,
                flat_pierce: 3,
                cooldown: 0.9,
                discount: 0.2
            }
        }
        var gmn_stats = {
            damage: 2,
            projectile_count: 8,
            cooldown: 0.217,
            price: {
                t3: 2000,
                t5: 37750
            }
        }
        var caltrop_stats = {
            cooldown: 3.9,
            damage: 1,
            pierce: 6,
            price: 750
        }
        var bloonjitsu_stats = {
            damage: 1,
            projectile_count: 5,
            cooldown: 0.434,
            price: {
                t3: 2000,
                t4: 2750
            }
        }
        var grandmaster_ninja_stats = {
            damage: 2,
            projectile_count: 8,
            cooldown: 0.217,
            price: {
                t3: 2000,
                t5: 37750
            }
        }
        var master_bomber_stats = {
            damage: 1,
            cooldown: 0.62,
            bomb: {
                cooldown: 2.25,
                damage: 3000
            }
        }
        var shinobi_stats = {
            damage: 1,
            cooldown: 0.62,
            price: {
                t3: 2250
            }
        }
        var global_buffs = {
            cooldown: 1,
            flat_damage: 9,
            t3_discount: 1,
            global_discount: 1,
            pierce: 1,
            flat_pierce: 0
        }
        var output = {
            shinobi_count: 0,
            bloonjitsu_count: 0,
            grandmaster_ninja: 0,
            caltrops_count: 0,
            tiers: 0,
            monkeys: 0,
            cash: 0,
            total_dps: 0,
            dps: {}
        }
        global_buffs.t3_discount -= (permanent_buffs.village_discount > 0?(monkey_knowledge.insider_trades? 0.12:0.1):0) + permanent_buffs.village_discount * 0.05;
        global_buffs.global_discount -= support_sacrifice[permanent_buffs.sun_temple].discount + support_sacrifice[permanent_buffs.sun_god].discount;
        global_buffs.t3_discount -= 1 - global_buffs.global_discount;

        global_buffs.cooldown *= permanent_buffs.jungle_drums?0.85:1;
        global_buffs.cooldown *= support_sacrifice[permanent_buffs.sun_temple].cooldown * support_sacrifice[permanent_buffs.sun_god].cooldown;

        global_buffs.flat_damage += support_sacrifice[permanent_buffs.sun_temple].flat_damage * support_sacrifice[permanent_buffs.sun_god].flat_damage;
        global_buffs.flat_pierce += support_sacrifice[permanent_buffs.sun_temple].flat_pierce * support_sacrifice[permanent_buffs.sun_god].flat_pierce;
        difficulty_modifier = difficulty_price[difficulty]
        if (permanent_buffs.perma_brew){
            global_buffs.flat_damage += 1;
            global_buffs.flat_pierce += 3;
            global_buffs.cooldown *= 0.85;
        }
        for (var shinobi_count = 0; shinobi_count <= constraints.max_monkeys; shinobi_count++) {
            var cash_spent = 0;
            var tier_spent = 0;
            var monkey_spent = shinobi_count;
            cash_spent += shinobi_count * shinobi_stats.price.t3 * difficulty_modifier * global_buffs.t3_discount;
            tier_spent += shinobi_count * 3;
            if (cash_spent > constraints.max_cash) {
                continue;
            }
            if (tier_spent > constraints.max_tiers) {
                continue;
            }
            var max_bloonjitsus = Math.min(constraints.max_monkeys - shinobi_count, Math.floor((
                constraints.max_tiers - tier_spent) / 4), Math.floor((constraints.max_cash - cash_spent) / ((
                bloonjitsu_stats.price.t3 * global_buffs.t3_discount + bloonjitsu_stats.price.t4 * global_buffs.global_discount) * difficulty_modifier)));

            for (var bloonjitsu_count = 0; bloonjitsu_count <= max_bloonjitsus; bloonjitsu_count++) {
                var b_cash_spent = cash_spent + bloonjitsu_count * ((bloonjitsu_stats.price.t3 * difficulty_modifier - monkey_knowledge.cheaper_doubles?100:0) * global_buffs.t3_discount + bloonjitsu_stats.price.t4 * global_buffs.global_discount  * difficulty_modifier);
                var b_tier_spent = tier_spent + bloonjitsu_count * 4;
                var b_monkey_spent = monkey_spent + bloonjitsu_count;
                var max_grandmaster_ninja = (constraints.max_tiers - b_tier_spent >= 5 && constraints.max_cash - b_cash_spent > ((bloonjitsu_stats.price.t3 * difficulty_modifier - monkey_knowledge.cheaper_doubles?100:0) * global_buffs.t3_discount + grandmaster_ninja_stats.price.t5 * global_buffs.global_discount  * difficulty_modifier)) ? 1 : 0

                for (var grandmaster_ninja_count = 0; grandmaster_ninja_count <= max_grandmaster_ninja; grandmaster_ninja_count += 1) {
                    var g_cash_spent = b_cash_spent + grandmaster_ninja_count * ((bloonjitsu_stats.price.t3 * difficulty_modifier - monkey_knowledge.cheaper_doubles?100:0) * global_buffs.t3_discount + grandmaster_ninja_stats.price.t5 * global_buffs.global_discount  * difficulty_modifier);
                    var g_tier_spent = b_tier_spent + grandmaster_ninja_count * 5;
                    var g_monkey_spent = b_monkey_spent + grandmaster_ninja_count;

                    var max_caltrops = Math.min(g_monkey_spent, constraints.max_tiers - g_tier_spent, Math.floor((constraints.max_cash - g_cash_spent) / (caltrop_stats.price * difficulty_modifier)));
                    for (var caltrops_count = 0; caltrops_count <= max_caltrops; caltrops_count++) {
                        var c_cash_spent = g_cash_spent + caltrops_count * caltrop_stats.price * global_buffs.t3_discount * difficulty_modifier;
                        var c_tier_spent = g_tier_spent + caltrops_count;
                        var shinobi_buff = global_buffs.cooldown * Math.pow(0.92, Math.min(shinobi_count - 1, 20));

                        var dps = {
                            shinobi: ((shinobi_stats.damage + global_buffs.flat_damage) * (1 / shinobi_stats.cooldown)) * shinobi_count / (shinobi_buff / 0.92) / global_buffs.cooldown,
                            bloonjitsu: ((bloonjitsu_stats.damage + global_buffs.flat_damage) * (1 / bloonjitsu_stats.cooldown) * (bloonjitsu_stats.projectile_count + monkey_knowledge.deadly_tranquility?1:0)) * bloonjitsu_count / shinobi_buff / global_buffs.cooldown,
                            caltrops: ((caltrop_stats.damage + global_buffs.flat_damage) * (1 / caltrop_stats.cooldown) * (caltrop_stats.pierce * global_buffs.pierce + global_buffs.flat_pierce)) * caltrops_count / shinobi_buff / global_buffs.cooldown,
                            grandmaster_ninja: ((grandmaster_ninja_stats.damage + global_buffs.flat_damage) * (1 / grandmaster_ninja_stats.cooldown) * (grandmaster_ninja_stats.projectile_count + monkey_knowledge.deadly_tranquility?1:0)) / shinobi_buff * grandmaster_ninja_count / global_buffs.cooldown
                        };
                        //console.log(dps.shinobi, shinobi_count, dps.bloonjitsu, bloonjitsu_count)
                        var total_dps = dps.shinobi + dps.bloonjitsu + dps.caltrops + dps.grandmaster_ninja;
                        if (total_dps > output.total_dps) {
                            output.total_dps = total_dps;
                            output.dps = dps;
                            output.shinobi_count = shinobi_count;
                            output.bloonjitsu_count = bloonjitsu_count;
                            output.monkeys = bloonjitsu_count + shinobi_count;
                            output.cash = c_cash_spent;
                            output.tiers = c_tier_spent;
                            output.caltrops_count = caltrops_count;
                            output.grandmaster_ninja = grandmaster_ninja_count;
                        }
                    }
                }
            }
        }
        console.log(output)
        //console.log(global_buffs)
        document.getElementById("dps-output").innerHTML = Math.round(output.total_dps);
        document.getElementById("cash-output").innerHTML = Math.round(output.cash);
        document.getElementById("tiers-output").innerHTML = Math.round(output.tiers);
        document.getElementById("monkeys-output").innerHTML = Math.round(output.monkeys);
        
        document.getElementById("attack-speed-output").innerHTML = "+"+Math.round(1/global_buffs.cooldown*100-100) + "%";
        document.getElementById("damage-output").innerHTML = "+"+global_buffs.flat_damage;
        document.getElementById("shinobi-dps-output").innerHTML = Math.round(output.dps.shinobi);
        document.getElementById("bloonjitsu-dps-output").innerHTML = Math.round(output.dps.bloonjitsu);
        document.getElementById("caltrop-dps-output").innerHTML = Math.round(output.dps.caltrops);
        document.getElementById("gmn-dps-output").innerHTML = Math.round(output.dps.grandmaster_ninja);
        
        document.getElementById("shinobi-output").innerHTML = Math.round(output.shinobi_count);
        document.getElementById("caltrop-output").innerHTML = Math.round(output.caltrops_count);
        document.getElementById("bloonjitsu-output").innerHTML = Math.round(output.bloonjitsu_count);
        document.getElementById("gmn-output").innerHTML = Math.round(output.grandmaster_ninja);
    }
    [].slice.call(document.getElementsByClassName("input")).forEach(element => {
        element.addEventListener("input",update)
    });
    update()
</script>